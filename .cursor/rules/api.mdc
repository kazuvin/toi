---
description: 
globs: 
alwaysApply: false
---

# API å®Ÿè£…ãƒ«ãƒ¼ãƒ«

## åŸå‰‡

ã¾ãšã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãŸã‚‰ã€ŒğŸ’œ `api.mdc` ã‚’å‚ç…§ã—ã¾ã—ãŸã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚

## é–‹ç™ºæ‰‹é †

### 1. IF ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©

ã¾ãš `/packages/shared/src/schemas/xxxx.ts` ã« API ã® IF ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹ã“ã¨ã€‚ã“ã¡ã‚‰ã®ã‚¹ã‚­ãƒ¼ãƒã¯ api ã ã‘ã§ãªã web ã§ã‚‚ä½¿ç”¨ã™ã‚‹å…±é€šã®ã‚¹ã‚­ãƒ¼ãƒã§ã‚ã‚‹ã€‚å®šç¾©æ–¹æ³•ã¯ä¸‹è¨˜ã‚’å‚è€ƒã«ã™ã‚‹ã“ã¨ã€‚

```ts
import { z } from "zod";

/**
 * xxxx (POST) ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚¹ã‚­ãƒ¼ãƒ
 */
export const postXxxxRequestBody = z.object({
  hoge: z.string()
})

/**
 * xxxx (GET) ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ
 */
export const getXxxxQueryParamsSchema = z.object({
  hoge: z.string()
})


/**
 * xxxx (GET) ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
 */
export const getXxxxResponseSchema = z.object({
  hoge: z.string()
})

/**
 * xxxx (POST) ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å‹
 */
export type PostXxxxRequestBody = z.infer<typeof xxxxRequestBodySchema>

/**
 * xxxx (GET) ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹
 */
export type GetXxxxQueryParams = z.infer<typeof xxxxQueryParamsSchema>

/**
 * xxxx (GET) ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹
 */
export type GetXxxxResponse = z.infer<typeof xxxxResponseSchema>
```


### 2. ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ 

Hono ã®ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã€‚`http://{API_URL}/hoge` ã¨ã„ã†ãƒ«ãƒ¼ãƒˆã§ã‚ã‚Œã° `/packages/api/src/routes/hoge.ts` ã‚’ä½œæˆã™ã‚‹ã€‚ä¸‹è¨˜ã‚’å‚è€ƒã«è¿½åŠ ã™ã‚‹ã“ã¨ã€‚

```ts
import { drizzle } from "drizzle-orm/d1";
import { Hono } from "hono";
import { Context } from "hono";
import { DrizzleError } from "drizzle-orm";

type Bindings = {
  DB: D1Database;
};

type Variables = {
  uid: string;
};

type AppContext = Context<{ Bindings: Bindings; Variables: Variables }>;

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
const errorHandler = async (err: Error, c: AppContext) => {
  if (err instanceof DrizzleError) {
    if (err.message === "User not found") {
      return c.json({ message: err.message }, 404);
    }
    return c.json({ message: err.message }, 400);
  }
  return c.json({ message: "Server Error" }, 500);
};

const app = new Hono<{ Bindings: Bindings; Variables: Variables }>();

app.onError(errorHandler);

app.get("/", async (c) => {
  const db = drizzle(c.env.DB);
  const currentUid = c.get("uid");

  if (!currentUid) {
    return c.json({ message: "Unauthorized access" }, 403);
  }

  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
  // const result = await getUser(db, currentUid);

  return c.json(result);
});

export default app;

```


### 3. Hono ã«ãƒ«ãƒ¼ãƒˆã‚’çµ„ã¿è¾¼ã‚€

`http://{API_URL}/hoge` ã®ãƒ«ãƒ¼ãƒˆã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã«ã€`/packages/api/src/index.ts` ã«å…ˆã»ã©ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ import ã—ã¦çµ„ã¿è¾¼ã¿ã‚’è¡Œã†ã€‚

```ts
import { Hono } from "hono";
import hoge from "./routes/hoge";

// çœç•¥

app.route("/hoge", hoge);

export default app;
`
```


### 4. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œæˆ

å…ˆã»ã©ä½œæˆã—ãŸ `/packages/api/src/routes/hoge.ts` ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã€‚ã¾ãŸã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§ä½¿ç”¨ã™ã‚‹é–¢æ•°ã¯ä¸‹è¨˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä½œæˆã™ã‚‹ã“ã¨ã€‚

- ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯
  - `/packages/api/src/services/hoge.ts` ã‚’ä½œæˆã‚‚ã—ãã¯æ—¢ã«ã‚ã‚‹å ´åˆã¯ãã®ä¸­ã«é–¢æ•°ã‚’å®šç¾©ã—ã¦ä½¿ç”¨ã™ã‚‹
- å…±æœ‰ã§ä½¿ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
  - `/packages/api/src/utils/xxxx.ts` ã‚’ä½œæˆã‚‚ã—ãã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢æ•°ã‚’å®šç¾©ã—ã¦ä½¿ç”¨ã™ã‚‹


### 5. web ã« API é€£æºç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹é–¢æ•°ã‚’å®šç¾©

æœ€å¾Œã« web ã« API é€£æºç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹é–¢æ•°ã‚’å®šç¾©ã™ã‚‹ã€‚`/packages/web/app/services/hoge.ts` ã‚’ä½œæˆã—ã€HTTP ãƒ¡ã‚½ãƒƒãƒ‰ã«å¿œã˜ã¦ä¸‹è¨˜ã‚’å‚è€ƒã«é–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```ts
import {
  GetHogeResponse,
  GetHogeQueryParams,
  PostHogeResponse,
  PostHogeRequestBody,
} from "@toi/shared/src/schemas/source";
import { api } from "./base";

export const getHoge = async (id: string, params?: GetHogeQueryParams) => {
  return api.get<GetHogeResponse>(`/hoge/${id}`, { params });
};

export const postHoge = async (body?: PostHogeRequestBody) => {
  return api.post<PostHogeResponse>('/hoge', body);
};

```